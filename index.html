<!DOCTYPE html>
<html lang="ka">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>áƒ©áƒ”áƒ›áƒ˜ áƒáƒ•áƒ¢áƒ áƒ áƒ£áƒ™áƒ</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <base target="_blank">
  <style>
    :root{
      --panel-w: 420px; --bg: #0b1220; --card: #111a2b; --acc: #86aefb; --text: #e6eefc;
    }
    html, body { height: 100%; margin: 0; background: var(--bg); color: var(--text); font-family: system-ui, sans-serif; }
    #app { height: 100%; display: grid; grid-template-columns: 1fr; }
    #map { height: 100%; }
    #panel { position: fixed; top: 0; right: 0; height: 100%; width: var(--panel-w); background: var(--card); border-left: 1px solid #23314f; box-shadow: -8px 0 24px rgba(0,0,0,.35); transform: translateX(100%); transition: transform .28s ease; display: flex; flex-direction: column; z-index: 9999; overflow: hidden; }
    #panel.open { transform: translateX(0); }
    #panel header { display: flex; align-items: center; justify-content: space-between; padding: 10px 14px; border-bottom: 1px solid #213150; }
    #panel header h3 { margin: 0; font-size: 16px; font-weight: 600; }
    #panel header button { background: transparent; color: var(--text); border: 1px solid #31466d; border-radius: 10px; padding: 6px 10px; cursor: pointer; }
    #panel-body { padding: 14px; overflow: auto; }
    .btn { display:inline-block; padding: 6px 10px; border: 1px solid #3a5590; color: white; border-radius: 10px; text-decoration: none; cursor: pointer; user-select: none; }
    .btn:hover { background: #1b2b50; }
    .btn-primary { background: #1a2a4e; }
    .brand { position: absolute; left: 12px; top: 12px; z-index: 500; background: #0d172b; border: 1px solid #22355f; border-radius: 12px; padding: 8px 10px; font-weight: 600; box-shadow: 0 6px 18px rgba(0,0,0,.25); }
  </style>
</head>
<body>
  <div id="app">
    <div id="map"></div>
    <div class="brand">ğŸŒ áƒáƒ•áƒ¢áƒ áƒ áƒ£áƒ™áƒ</div>
  </div>
  <aside id="panel" aria-hidden="true">
    <header>
      <h3 id="panel-title">áƒ“áƒáƒ™áƒ£áƒ›áƒ”áƒœáƒ¢áƒ˜</h3>
      <div>
        <button id="open-md-raw" class="btn" title="áƒ’áƒáƒ®áƒ¡áƒœáƒ áƒ¬áƒ§áƒáƒ áƒ áƒ‘áƒ›áƒ£áƒšáƒ˜áƒ—">Raw</button>
        <button id="panel-close" class="btn">áƒ“áƒáƒ®áƒ£áƒ áƒ•áƒ</button>
      </div>
    </header>
    <div id="panel-body">
      <p style="opacity:.8">áƒáƒ˜áƒ áƒ©áƒ˜áƒ” áƒ áƒ£áƒ™áƒáƒ–áƒ” áƒ¬áƒ”áƒ áƒ¢áƒ˜áƒšáƒ˜ áƒ“áƒ áƒ“áƒáƒáƒ­áƒ˜áƒ áƒ” <em>â€œáƒ™áƒ˜áƒ—áƒ®áƒ•áƒâ€</em> áƒ¦áƒ˜áƒšáƒáƒ™áƒ¡ â€” áƒ¨áƒ”áƒ¡áƒáƒ‘áƒáƒ›áƒ˜áƒ¡áƒ˜ Markdown áƒ¤áƒáƒ˜áƒšáƒ˜ áƒ©áƒáƒ˜áƒ¢áƒ•áƒ˜áƒ áƒ—áƒ”áƒ‘áƒ áƒáƒ¥.</p>
    </div>
  </aside>
  <script>
    const map = L.map('map').setView([41.72, 44.78], 7);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19 }).addTo(map);
    const panel = document.getElementById('panel');
    const panelTitle = document.getElementById('panel-title');
    const panelBody  = document.getElementById('panel-body');
    const openRawBtn = document.getElementById('open-md-raw');
    document.getElementById('panel-close').onclick = () => panel.classList.remove('open');
    async function loadMarkdown({ url, title }) {
      if (!url) { panelTitle.textContent = title || 'áƒ“áƒáƒ™áƒ£áƒ›áƒ”áƒœáƒ¢áƒ˜'; panelBody.innerHTML = '<p>áƒ‘áƒ›áƒ£áƒšáƒ˜ áƒáƒ áƒáƒ</p>'; panel.classList.add('open'); return; }
      try {
        panelTitle.textContent = title || 'áƒ“áƒáƒ™áƒ£áƒ›áƒ”áƒœáƒ¢áƒ˜';
        panelBody.innerHTML = '<p>áƒ©áƒáƒ¢áƒ•áƒ˜áƒ áƒ—áƒ•áƒ...</p>';
        const res = await fetch(url, { cache: 'no-cache' });
        const text = await res.text();
        panelBody.innerHTML = marked.parse(text);
        openRawBtn.onclick = () => window.open(url, '_blank');
        panel.classList.add('open');
      } catch (err) { panelBody.innerHTML = `<p>áƒ•áƒ”áƒ  áƒ©áƒáƒ˜áƒ¢áƒ•áƒ˜áƒ áƒ—áƒ: ${err}</p>`; panel.classList.add('open'); }
    }
    function popupHtml(props, latlng){
      const title = props.title || 'áƒ£áƒ¡áƒáƒ—áƒáƒ£áƒ áƒ áƒáƒ‘áƒ˜áƒ”áƒ¥áƒ¢áƒ˜';
      const descr = props.description || '';
      const mdUrl = props.md || props.mdPath || '';
      const dest = latlng ? `${latlng.lat.toFixed(6)},${latlng.lng.toFixed(6)}` : '';
      const btnMd = `<button class="btn btn-primary" onclick="loadMarkdown({url: '${mdUrl}', title: '${title.replace(/'/g, "&#39;")}'})">áƒ™áƒ˜áƒ—áƒ®áƒ•áƒ</button>`;
      const btnLink = props.link ? `<a class=\"btn\" href=\"${props.link}\">áƒ‘áƒ›áƒ£áƒšáƒ˜</a>` : '';
      let btnRoute = '';
      if(dest){
        const userAgent = navigator.userAgent || navigator.vendor || window.opera;
        if (/android/i.test(userAgent)) {
          btnRoute = `<a class=\"btn\" href=\"geo:${dest}\" target=\"_blank\">áƒ›áƒáƒ áƒ¨áƒ áƒ£áƒ¢áƒ˜ â–¶</a>`;
        } else if (/iPad|iPhone|iPod/.test(userAgent) && !window.MSStream) {
          btnRoute = `<a class=\"btn\" href=\"http://maps.apple.com/?daddr=${dest}\" target=\"_blank\">áƒ›áƒáƒ áƒ¨áƒ áƒ£áƒ¢áƒ˜ â–¶</a>`;
        } else {
          btnRoute = `<a class=\"btn\" href=\"https://www.google.com/maps/dir/?api=1&destination=${dest}\" target=\"_blank\" rel=\"noopener\">áƒ›áƒáƒ áƒ¨áƒ áƒ£áƒ¢áƒ˜ â–¶</a>`;
        }
      }
      return `<div style=\"min-width:220px\"><div style=\"font-weight:700;margin-bottom:6px\">${title}</div><div style=\"opacity:.9;margin-bottom:8px\">${descr}</div><div style=\"display:flex; gap:8px; flex-wrap:wrap\">${btnMd}${btnLink}${btnRoute}</div></div>`;
    }
    function addGeoJsonLayer(geojson){
      return L.geoJSON(geojson, {
        pointToLayer: (feature, latlng) => L.marker(latlng),
        onEachFeature: (feature, layer) => {
          const latlng = layer.getLatLng();
          layer.bindPopup(popupHtml(feature.properties || {}, latlng));
        }
      }).addTo(map);
    }
    const externalGeoJsonUrl = 'data/points.geojson';
    (async function init(){
      try {
        const res = await fetch(externalGeoJsonUrl, { cache: 'no-cache' });
        if (!res.ok) throw new Error('no external geojson');
        const gj = await res.json();
        addGeoJsonLayer(gj);
      } catch(e){
        addGeoJsonLayer(DEMO_GEOJSON);
      }
    })();
    const DEMO_GEOJSON = {"type":"FeatureCollection","features":[{"type":"Feature","properties":{"title":"áƒ—áƒ‘áƒ˜áƒšáƒ˜áƒ¡áƒ˜áƒ¡ áƒ¢áƒ”áƒšáƒ”áƒáƒœáƒ«áƒ","description":"áƒ¡áƒáƒ˜áƒœáƒ¢áƒ”áƒ áƒ”áƒ¡áƒ áƒ®áƒ”áƒ“áƒ”áƒ‘áƒ˜","md":"https://raw.githubusercontent.com/markdown-it/markdown-it/master/README.md"},"geometry":{"type":"Point","coordinates":[44.7879,41.7096]}},{"type":"Feature","properties":{"title":"áƒ‘áƒáƒ—áƒ£áƒ›áƒ˜áƒ¡ áƒ‘áƒ£áƒšáƒ•áƒáƒ áƒ˜","description":"áƒ¨áƒáƒ•áƒ˜ áƒ–áƒ¦áƒ•áƒ˜áƒ¡ áƒ¡áƒáƒœáƒáƒáƒ˜áƒ áƒ","md":"https://raw.githubusercontent.com/adam-p/markdown-here/master/README.md"},"geometry":{"type":"Point","coordinates":[41.6339,41.6469]}}]};
  </script>
</body>
</html>
