<!DOCTYPE html>
<html lang="ka">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ჩემი ავტო რუკა</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- MarkerCluster მხოლოდ LPG ფენისთვის -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

  <!-- Markdown renderer (პანელისთვის) -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

  <!-- Fuse.js (ფაზური ძიება) -->
  <script src="https://cdn.jsdelivr.net/npm/fuse.js@6.6.2"></script>

  <base target="_blank">

  <style>
    :root{ --panel-w: 420px; --bg:#0b1220; --card:#111a2b; --acc:#86aefb; --text:#e6eefc; --vh: 1vh; }
    html, body { height: 100%; margin: 0; background: var(--bg); color: var(--text); font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; }
    #app { height: 100%; display: grid; grid-template-columns: 1fr; }
    #map { height: calc(var(--vh) * 100); width: 100%; }

    /* Slide panel */
    #panel { position: fixed; top: 0; right: 0; height: 100%; width: min(100%, var(--panel-w)); background: var(--card);
             border-left: 1px solid #23314f; box-shadow: -8px 0 24px rgba(0,0,0,.35); transform: translateX(100%);
             transition: transform .28s ease; display: flex; flex-direction: column; z-index: 9999; overflow: hidden; }
    #panel.open { transform: translateX(0); }
    #panel header { display: flex; align-items: center; justify-content: space-between; padding: 10px 14px; border-bottom: 1px solid #213150; }
    #panel header h3 { margin: 0; font-size: 16px; font-weight: 600; }
    #panel header button { background: transparent; color: var(--text); border: 1px solid #31466d; border-radius: 10px; padding: 6px 10px; cursor: pointer; }
    #panel-body { padding: 14px; overflow: auto; }

    .btn { display:inline-block; padding: 6px 10px; border: 1px solid #3a5590; color: white; border-radius: 10px; text-decoration: none; cursor: pointer; user-select: none; }
    .btn:hover { background: #1b2b50; }
    .btn-primary { background: #1a2a4e; }

    .brand { position: absolute; left: 50px; top: 12px; z-index: 500; background: #0d172b; border: 1px solid #22355f;
             border-radius: 12px; padding: 8px 10px; font-weight: 600; box-shadow: 0 6px 18px rgba(0,0,0,.25); }

    /* ⛽ LPG marker (DivIcon) */
    .gas-icon{ font-size: 20px; line-height: 24px; width: 24px; height: 24px; text-align: center; filter: drop-shadow(0 1px 2px rgba(0,0,0,.55)); }

    /* ბრენდ-ფილტრის კონტროლი */
    .lpg-filter {
      background: #0d172b; border: 1px solid #243a63; border-radius: 12px;
      box-shadow: 0 6px 18px rgba(0,0,0,.25); color: #e6eefc; min-width: 180px;
      padding: 8px 10px; font-size: 13px;
      max-height: 260px; overflow: hidden; display: grid; grid-template-rows: auto auto 1fr auto;
    }
    .lpg-filter .head { display:flex; align-items:center; justify-content:space-between; gap:8px; margin-bottom:6px; }
    .lpg-filter .head h4 { margin: 0; font-size: 13px; font-weight: 700; }
    .lpg-filter .head .hide-btn{
      border: 1px solid #325084; background: #132343; color: #e6eefc; border-radius: 8px; padding: 2px 8px; cursor: pointer; font-size:12px;
    }
    .lpg-filter .actions { display: flex; gap: 8px; margin: 6px 0 8px; }
    .lpg-filter .actions button {
      border: 1px solid #325084; background: #132343; color: #e6eefc; border-radius: 8px; padding: 4px 8px; cursor: pointer;
    }
    .lpg-filter .list { overflow: auto; max-height: 170px; padding-right: 4px; }
    .lpg-filter label { display: flex; align-items: center; gap: 8px; padding: 4px 2px; }
    .lpg-filter small { opacity: .75; }

    .leaflet-control { filter: drop-shadow(0 1px 2px rgba(0,0,0,.25)); }

    /* ძიების UI */
    .search-toggle {
      background: #0d172b; border: 1px solid #243a63; border-radius: 999px; color:#e6eefc;
      padding: 6px 10px; font-size: 13px; cursor: pointer; box-shadow: 0 6px 18px rgba(0,0,0,.25);
    }
    .search-panel {
      background:#0d172b; border:1px solid #243a63; border-radius:12px; padding:10px; width:min(92vw,360px);
      color:#e6eefc; box-shadow:0 6px 18px rgba(0,0,0,.25);
    }
    .search-panel input {
      width:100%; padding:10px 12px; border-radius:10px; border:1px solid #2c4a7d; background:#0a1428; color:#e6eefc;
      outline:none;
    }
    .search-results { margin-top:8px; max-height:240px; overflow:auto; }
    .result-item {
      display:flex; align-items:flex-start; gap:10px; padding:8px; border:1px solid #223a66; border-radius:10px; margin-bottom:6px; cursor:pointer;
      background:#0a1428;
    }
    .result-item:hover { background:#0f1b33; }
    .result-item .badge { font-size:12px; opacity:.85; padding:2px 6px; border:1px solid #325084; border-radius:8px; }
    .result-item .title { font-weight:700; }
    .result-item .sub { opacity:.8; font-size:12px; margin-top:2px; }

    /* Nearby კონტროლი */
    .nearby-panel {
      background:#0d172b; border:1px solid #243a63; border-radius:12px; padding:10px; width:min(92vw,300px);
      color:#e6eefc; box-shadow:0 6px 18px rgba(0,0,0,.25);
    }
    .nearby-panel .row{ display:grid; grid-template-columns: 1fr auto; gap:8px; align-items:center; margin:6px 0; }
    .nearby-panel input[type="range"]{ width:100%; }
    .nearby-panel input[type="number"]{
      width:90px; padding:6px 8px; border-radius:10px; border:1px solid #2c4a7d; background:#0a1428; color:#e6eefc;
    }
    .nearby-actions{ display:flex; gap:8px; margin-top:8px; }
    .nearby-actions button{
      border: 1px solid #325084; background: #132343; color: #e6eefc; border-radius: 8px; padding: 6px 10px; cursor: pointer;
    }
    /* Nearby: ჩაკეცვადი ჰედერი */
    .nearby-panel .nb-header{
      display:flex; align-items:center; justify-content:space-between; gap:8px;
      cursor:pointer; padding:2px 2px 6px; border-bottom:1px dashed #243a63; margin-bottom:6px;
    }
    .nearby-panel .nb-header strong{ font-size:13px; }

    @media (max-width: 420px){
      .lpg-filter{ min-width: 200px; }
      .brand{ left: 8px; }
    }
  </style>
</head>
<body>
  <div id="app">
    <div id="map"></div>
    <div class="brand">🌍 ავტო რუკა</div>
  </div>

  <!-- Slide panel -->
  <aside id="panel" aria-hidden="true">
    <header>
      <h3 id="panel-title">დოკუმენტი</h3>
      <div>
        <button id="open-md-raw" class="btn" title="გახსნა წყარო ბმულით">Raw</button>
        <button id="panel-close" class="btn">დახურვა</button>
      </div>
    </header>
    <div id="panel-body">
      <p style="opacity:.8">აირჩიე რუკაზე წერტილი და დააჭირე <em>“კითხვა”</em> ღილაკს — შესაბამისი Markdown ფაილი ჩაიტვირთება აქ.</p>
    </div>
  </aside>

  <script>
    // Mobile 100vh fix
    function setVh(){ document.documentElement.style.setProperty('--vh', (window.innerHeight * 0.01) + 'px'); }
    setVh(); window.addEventListener('resize', setVh);

    // --- Base layers
    const osm     = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19 });
    const osmHot  = L.tileLayer('https://{s}.tile.openstreetmap.fr/hot/{z}/{x}/{y}.png', { maxZoom: 19 });
    const esriSat = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', { maxZoom: 19 });

    const map = L.map('map', { center: [41.72, 44.78], zoom: 7, layers: [osm] });

    const baseLayers = {
      'OpenStreetMap': osm,
      'OSM Humanitarian': osmHot,
      'Esri Satellite': esriSat
    };

    // Layer Control: collapsed: true ✅ (ოვერლეიები ნაგულისხმევად გამორთული)
    const layerControl = L.control.layers(baseLayers, {}, { collapsed: true }).addTo(map);

    // --- Slide panel helpers ---
    const panel      = document.getElementById('panel');
    const panelTitle = document.getElementById('panel-title');
    const panelBody  = document.getElementById('panel-body');
    const openRawBtn = document.getElementById('open-md-raw');
    document.getElementById('panel-close').onclick = () => panel.classList.remove('open');

    async function loadMarkdown({ url, title }) {
      if (!url) { panelTitle.textContent = title || 'დოკუმენტი'; panelBody.innerHTML = '<p>ბმული არაა</p>'; panel.classList.add('open'); return; }
      try {
        panelTitle.textContent = title || 'დოკუმენტი';
        panelBody.innerHTML = '<p>ჩატვირთვა...</p>';
        const res = await fetch(url, { cache: 'no-cache' });
        const text = await res.text();
        panelBody.innerHTML = marked.parse(text);
        openRawBtn.onclick = () => window.open(url, '_blank');
        panel.classList.add('open');
      } catch (err) { panelBody.innerHTML = `<p>ვერ ჩაიტვირთა: ${err}</p>`; panel.classList.add('open'); }
    }

    function popupHtml(props, latlng){
      const p = props || {};
      const title = p.title || p.name || p.station || p.Name || 'უსათაურო ობიექტი';
      const descr = p.description || p.desc || p.address || '';
      const mdUrl = p.md || p.mdPath || '';
      const dest  = latlng ? `${latlng.lat.toFixed(6)},${latlng.lng.toFixed(6)}` : '';

      const btnMd   = `<button class="btn btn-primary" onclick="loadMarkdown({url: '${mdUrl}', title: '${(title+'').replace(/'/g, '&#39;')}'})">კითხვა</button>`;
      const btnLink = p.link ? `<a class="btn" href="${p.link}">ბმული</a>` : '';

      let btnRoute = '';
      if(dest){
        const ua = navigator.userAgent || navigator.vendor || window.opera;
        if (/android/i.test(ua)) {
          btnRoute = `<a class="btn" href="geo:${dest}" target="_blank">მარშრუტი ▶</a>`;
        } else if (/iPad|iPhone|iPod/.test(ua) && !window.MSStream) {
          btnRoute = `<a class="btn" href="http://maps.apple.com/?daddr=${dest}" target="_blank">მარშრუტი ▶</a>`;
        } else {
          btnRoute = `<a class="btn" href="https://www.google.com/maps/dir/?api=1&destination=${dest}" target="_blank" rel="noopener">მარშრუტი ▶</a>`;
        }
      }

      return `<div style="min-width:220px">
        <div style="font-weight:700;margin-bottom:6px">${title}</div>
        <div style="opacity:.9;margin-bottom:8px">${descr}</div>
        <div style="display:flex; gap:8px; flex-wrap:wrap">${btnMd}${btnLink}${btnRoute}</div>
      </div>`;
    }

    // --- points.geojson ლAYER (ოვერლეი, სტარტზე გამორთული)
    function makeGeoJsonLayer(geojson, opts = {}){
      const layer = L.geoJSON(geojson, {
        pointToLayer: (feature, latlng) => opts.icon ? L.marker(latlng, { icon: opts.icon }) : L.marker(latlng),
        onEachFeature: (feature, lyr) => {
          const latlng = lyr.getLatLng();
          lyr.bindPopup(popupHtml(feature.properties || {}, latlng));
        }
      });
      return layer;
    }

    // --- LPG: MarkerCluster + ბრენდ ფილტრი
    const gasIcon = L.divIcon({ className: 'gas-icon', html: '⛽', iconSize: [24,24], iconAnchor: [12,12] });

    function detectBrand(name) {
      if (!name) return 'OTHER';
      const raw = String(name);
      const m = raw.match(/LPG\s*[–—-]\s*([^|,;/\\]+)\s*$/i);
      if (m && m[1]) return m[1].trim().toUpperCase();
      const s = raw.toUpperCase().replace(/\s+/g, '');
      if (s.includes('AUTOLPGAS')) return 'AUTOLPGAS';
      if (s.includes('NEOGAS'))    return 'NEOGAS';
      if (s.includes('URIDGAS'))   return 'URIDGAS';
      return 'OTHER';
    }

    function buildLpgBrandData(geojson) {
      const clustersByBrand = {};      // brand -> MarkerClusterGroup (full)
      const countsByBrand   = {};      // brand -> count
      const brandList       = [];
      const markersByKey    = {};      // key -> {marker, brand, props}

      function clusterFor(brand){
        if (!clustersByBrand[brand]) {
          clustersByBrand[brand] = L.markerClusterGroup({ disableClusteringAtZoom: 15 });
          countsByBrand[brand] = 0;
          brandList.push(brand);
        }
        return clustersByBrand[brand];
      }

      (geojson.features || []).forEach(f => {
        if (!f?.geometry || f.geometry.type !== 'Point') return;
        const c = f.geometry.coordinates; if (!Array.isArray(c) || c.length < 2) return;

        const bName = detectBrand(f.properties?.Name || f.properties?.name || f.properties?.title);
        const brand = 'LPG - ' + bName;
        const latlng = L.latLng(c[1], c[0]);
        const marker = L.marker(latlng, { icon: gasIcon });
        marker.feature = f;
        marker.bindPopup(popupHtml(f.properties || {}, latlng));

        const k = JSON.stringify([f.properties?.Name || f.properties?.name || f.properties?.title || '', c[0], c[1], 'LPG']);
        markersByKey[k] = { marker, brand, props: f.properties || {} };

        clusterFor(brand).addLayer(marker);
        countsByBrand[brand] += 1;
      });

      brandList.sort();
      return { clustersByBrand, countsByBrand, brandList, markersByKey };
    }

    // URLs
    const mainUrl = 'data/points.geojson';
    const lpgUrl  = 'data/LPG.geojson';

    // Overlay placeholders (სტარტზე არცერთი არ არის რუკაზე)
    let mainLayer = null;
    const lpgMaster = L.layerGroup();
    layerControl.addOverlay(lpgMaster, '⛽ LPG');

    // ----------------------- LPG FILTER CONTROL + TOGGLE -----------------------
    const LpgFilterControl = L.Control.extend({
      options: { position: 'topright' },
      onAdd: function() {
        const div = L.DomUtil.create('div', 'lpg-filter');
        div.style.display = 'none';
        div.innerHTML = `
          <div class="head">
            <h4>⛽ LPG ბრენდები</h4>
            <button type="button" id="lpgHide" class="hide-btn" title="დამალვა">დამალვა</button>
          </div>
          <div class="actions">
            <button type="button" id="lpgAll">ყველა</button>
            <button type="button" id="lpgNone">არცერთი</button>
          </div>
          <div class="list" id="lpgList"></div>
        `;
        L.DomEvent.disableClickPropagation(div);
        this._container = div;

        // hide button -> emit event so toggle chip გამოჩნდეს
        div.querySelector('#lpgHide').addEventListener('click', ()=>{
          this.hide();
        });

        return div;
      },
      setBrands(brandList, countsByBrand, onChange) {
        const list = this._container.querySelector('#lpgList');
        list.innerHTML = '';
        brandList.forEach(b => {
          const id = 'b_' + b.replace(/\W+/g, '_');
          const count = countsByBrand[b] || 0;
          const row = document.createElement('label');
          row.innerHTML = `
            <input type="checkbox" id="${id}" data-brand="${b}" checked />
            <span>${b} <small>(${count})</small></span>
          `;
          list.appendChild(row);
        });
        list.querySelectorAll('input[type="checkbox"]').forEach(cb => {
          cb.addEventListener('change', () => onChange(this.selectedBrands()));
        });
        this._container.querySelector('#lpgAll').onclick  = () => {
          list.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = true);
          onChange(this.selectedBrands());
        };
        this._container.querySelector('#lpgNone').onclick = () => {
          list.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
          onChange(this.selectedBrands());
        };
        this._onChange = onChange;
      },
      selectedBrands() {
        return Array.from(this._container.querySelectorAll('input[type="checkbox"]:checked'))
          .map(cb => cb.getAttribute('data-brand'));
      },
      setChecked(brands) {
        const list = this._container.querySelector('#lpgList');
        list.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = brands.includes(cb.getAttribute('data-brand')));
        this._onChange && this._onChange(this.selectedBrands());
      },
      show() { this._container.style.display = ''; map.fire('lpgfilter:show'); },
      hide() { this._container.style.display = 'none'; map.fire('lpgfilter:hide'); },
      isHidden(){ return this._container.style.display === 'none'; }
    });
    const lpgFilter = new LpgFilterControl();
    map.addControl(lpgFilter);

    // პატარა toggle-ჩიპი „⛽ ბრენდები“
    const LpgFilterToggle = L.Control.extend({
      options: { position: 'topright' },
      onAdd: function(){
        const btn = L.DomUtil.create('button', 'search-toggle');
        btn.style.display = 'none';
        btn.type = 'button';
        btn.title = 'ბრენდების ფილტრი';
        btn.innerHTML = '⛽ ბრენდები';
        L.DomEvent.on(btn, 'click', (e)=>{ L.DomEvent.stopPropagation(e); lpgFilter.show(); this.hide(); });
        this._container = btn;
        return btn;
      },
      show(){ this._container.style.display = ''; },
      hide(){ this._container.style.display = 'none'; }
    });
    const lpgFilterToggle = new LpgFilterToggle();
    map.addControl(lpgFilterToggle);

    // toggle chip visibility sync
    map.on('lpgfilter:hide', ()=> lpgFilterToggle.show());
    map.on('lpgfilter:show', ()=> lpgFilterToggle.hide());

    // Geolocate control (მდებარეობა) — Top Left
    const Geolocate = L.Control.extend({
      options: { position: 'topleft' },
      onAdd: function(){
        const btn = L.DomUtil.create('button', 'search-toggle');
        btn.type = 'button';
        btn.title = 'ჩემი მდებარეობა';
        btn.innerHTML = '📍 ჩემი მდებარეობა';
        L.DomEvent.on(btn, 'click', (e) => {
          L.DomEvent.stopPropagation(e);
          map.locate({ setView: true, maxZoom: 15, enableHighAccuracy: true });
        });
        return btn;
      }
    });
    map.addControl(new Geolocate());

    let meMarker = null, meCircle = null;
    map.on('locationfound', (e) => {
      if (meMarker) map.removeLayer(meMarker);
      if (meCircle) map.removeLayer(meCircle);
      meMarker = L.marker(e.latlng).addTo(map).bindPopup('თქვენ ხართ აქ').openPopup();
      meCircle = L.circle(e.latlng, { radius: e.accuracy }).addTo(map);
    });
    map.on('locationerror', (e) => alert('მდებარეობა ვერ იქნა მიღებული: ' + e.message));

    // --- ძიების კონტროლი — Top Left
    const SearchControl = L.Control.extend({
      options: { position: 'topleft' },
      onAdd: function(){
        const div = L.DomUtil.create('div');
        const btn = L.DomUtil.create('button', 'search-toggle', div);
        btn.type = 'button'; btn.title = 'ძიება'; btn.innerHTML = '🔎 ძიება';
        const panel = L.DomUtil.create('div', 'search-panel', div);
        panel.style.display = 'none';
        panel.innerHTML = `<input id="searchInput" placeholder="სადგურის სახელი, მისამართი, ბრენდი..." />
                           <div class="search-results" id="searchResults"></div>`;
        const input = panel.querySelector('#searchInput');
        L.DomEvent.on(btn, 'click', (e) => {
          L.DomEvent.stopPropagation(e);
          panel.style.display = (panel.style.display === 'none') ? '' : 'none';
          if (panel.style.display !== 'none') input.focus();
        });
        L.DomEvent.disableClickPropagation(panel);
        this._panel = panel;
        this._results = panel.querySelector('#searchResults');
        this._input = input;
        return div;
      },
      setSearch(fn){ this._search = fn; },
      showResults(items){
        const box = this._results; box.innerHTML = '';
        if (!items.length) { box.innerHTML = '<div style="opacity:.8;padding:6px 4px">ვერაფერი მოიძებნა…</div>'; return; }
        items.slice(0, 50).forEach(it => {
          const el = document.createElement('div');
          el.className = 'result-item';
          el.innerHTML = `
            <div class="badge">${it.item.source === 'lpg' ? '⛽ LPG' : '📍 Point'}</div>
            <div>
              <div class="title">${(it.item.label||'უსათაურო')}</div>
              <div class="sub">${it.item.sublabel || ''}${it.item.brandLabel ? (' · ' + it.item.brandLabel) : ''}</div>
            </div>`;
          el.onclick = () => this._select && this._select(it.item);
          box.appendChild(el);
        });
      },
      bindInput(){
        const input = this._input;
        input.addEventListener('input', () => {
          const q = input.value.trim();
          const arr = this._search ? this._search(q) : [];
          this.showResults(arr);
        });
      },
      setSelect(fn){ this._select = fn; }
    });
    const searchCtl = new SearchControl();
    map.addControl(searchCtl);

    // ----------------------- DATA HOLDERS -----------------------
    // LPG
    let lpgReady = false;
    let lpgClustersByBrand = {};         // full
    let lpgCountsByBrand = {};
    let lpgBrandList = [];
    let lpgMarkersByKey = {};

    function applyLpgSelection(){
      if (!lpgReady) return;
      lpgMaster.clearLayers();
      const selected = lpgFilter.selectedBrands();
      selected.forEach(b => { const cl = lpgClustersByBrand[b]; if (cl) lpgMaster.addLayer(cl); });
    }

    map.on('overlayadd',  e => {
      if (e.layer === lpgMaster) {
        if (lpgReady) {
          applyLpgSelection();
          // თუ მომხმარებელმა დამალა ფანჯარა, აჩვენე ჩიპი, თორემ აჩვენე თავად ფანჯარა
          if (lpgFilter.isHidden()) { lpgFilterToggle.show(); } else { lpgFilter.show(); lpgFilterToggle.hide(); }
        } else {
          lpgFilter.hide(); lpgFilterToggle.hide();
        }
      }
    });
    map.on('overlayremove', e => {
      if (e.layer === lpgMaster) { lpgMaster.clearLayers(); lpgFilter.hide(); lpgFilterToggle.hide(); }
    });

    // ----------------------- NEARBY FILTER (გამოსწორებული) -----------------------
    let nearbyActive = false;
    let nearbyCenter = null;
    let nearbyCircle = null;
    let pointsFilteredGroup = null; // cloned markers

    function updateNearbyLabel(){
      if (!nearbyCtl || !nearbyCtl._label) return;
      nearbyCtl._label.textContent = nearbyCenter ? `ცენტრი: ${nearbyCenter.lat.toFixed(5)}, ${nearbyCenter.lng.toFixed(5)}` : 'ცენტრი: უცნობია';
    }

    async function ensureCenterFromGeolocation(){
      if (nearbyCenter) return nearbyCenter;
      if (meMarker) { nearbyCenter = meMarker.getLatLng(); updateNearbyLabel(); return nearbyCenter; }
      return new Promise((resolve, reject)=>{
        map.once('locationfound', e => { nearbyCenter = e.latlng; updateNearbyLabel(); resolve(nearbyCenter); });
        map.once('locationerror', e => reject(e));
        map.locate({ setView: false, enableHighAccuracy: true });
      });
    }

    function buildPointsFiltered(center, radiusM){
      if (!mainLayer) return null;
      if (pointsFilteredGroup) { map.removeLayer(pointsFilteredGroup); pointsFilteredGroup = null; }
      const grp = L.layerGroup();
      mainLayer.eachLayer(m => {
        if (!m.getLatLng) return;
        const ll = m.getLatLng();
        if (map.distance(center, ll) <= radiusM) {
          const p  = (m.feature && m.feature.properties) || {};
          const marker = L.marker(ll);
          marker.feature = { properties: p };
          marker.bindPopup(popupHtml(p, ll));
          grp.addLayer(marker);
        }
      });
      pointsFilteredGroup = grp;
      return grp;
    }

    //თვისებადი: Nearby შემთხვევაში LPG-ზე უბრალოდ flyTo, რადგან კლასტერში კოპირებულია მარკერები
    function buildLpgFiltered(center, radiusM){
      // ამ ვერსიაში Nearby მხოლოდ points-ს ფილტრავს; LPG-ს არ ვკლონავთ — გაქცევას ავარიდეთ
      // თუ გინდა LPG-მაც გაიფილტროს, შემატყობინე — დავამატებ clone-კლასტერს.
    }

    function applyNearby(center, radiusKm){
      const radiusM = radiusKm * 1000;

      if (!nearbyCircle) {
        nearbyCircle = L.circle(center, { radius: radiusM, color: '#86aefb', weight: 2, fillColor: '#86aefb', fillOpacity: 0.08 }).addTo(map);
      } else {
        nearbyCircle.setLatLng(center).setRadius(radiusM);
      }

      const filtered = buildPointsFiltered(center, radiusM);
      if (map.hasLayer(mainLayer)) { map.removeLayer(mainLayer); if (filtered) filtered.addTo(map); }

      nearbyActive = true;
    }

    function clearNearby(){
      nearbyActive = false;
      if (nearbyCircle) { map.removeLayer(nearbyCircle); nearbyCircle = null; }
      if (pointsFilteredGroup && map.hasLayer(pointsFilteredGroup)) {
        map.removeLayer(pointsFilteredGroup);
        if (mainLayer) map.addLayer(mainLayer);
      }
      pointsFilteredGroup = null;
    }

    // overlay toggle swap for points
    map.on('overlayadd', e => {
      if (mainLayer && e.layer === mainLayer && nearbyActive && pointsFilteredGroup) {
        map.removeLayer(mainLayer);
        pointsFilteredGroup.addTo(map);
      }
    });
    map.on('overlayremove', e => {
      if (pointsFilteredGroup && e.layer === mainLayer) {
        if (map.hasLayer(pointsFilteredGroup)) map.removeLayer(pointsFilteredGroup);
      }
    });

    // --- Nearby კონტროლი: bottomleft + ჩაკეცვადი (►/▼) ---
    const NearbyControl = L.Control.extend({
      options: { position: 'bottomleft' },
      onAdd: function(){
        const div = L.DomUtil.create('div', 'nearby-panel');
        div.innerHTML = `
          <div class="nb-header" id="nbHeader">
            <strong>🎯 მახლობლად</strong>
            <span id="nbArrow">►</span>
          </div>
          <div class="nb-body" id="nbBody" style="display:none">
            <div class="row">
              <label>რადიუსი (კმ):</label>
              <input type="number" id="nbNum" min="1" max="100" step="1" value="5" />
            </div>
            <input type="range" id="nbRange" min="1" max="100" step="1" value="5" />
            <div class="row">
              <span id="nbCenter">ცენტრი: უცნობია</span>
              <button type="button" id="nbLocate">ჩემი მდებარეობა</button>
            </div>
            <div class="nearby-actions">
              <button type="button" id="nbApply">გამოიყენე</button>
              <button type="button" id="nbClear">გასუფთავება</button>
            </div>
          </div>`;
        L.DomEvent.disableClickPropagation(div);

        const header = div.querySelector('#nbHeader');
        const body   = div.querySelector('#nbBody');
        const arrow  = div.querySelector('#nbArrow');
        header.addEventListener('click', ()=>{
          const open = body.style.display !== 'none';
          body.style.display = open ? 'none' : '';
          arrow.textContent  = open ? '►' : '▼';
        });

        // refs
        this._panel = body;
        this._num   = body.querySelector('#nbNum');
        this._rng   = body.querySelector('#nbRange');
        this._label = body.querySelector('#nbCenter');
        this._locBtn= body.querySelector('#nbLocate');
        this._apply = body.querySelector('#nbApply');
        this._clear = body.querySelector('#nbClear');

        // range<->number sync
        this._rng.addEventListener('input', ()=> this._num.value = this._rng.value);
        this._num.addEventListener('input', ()=> this._rng.value = this._num.value);

        // bind buttons HERE (უფრო საიმედოა)
        this._locBtn.addEventListener('click', async ()=>{
          try {
            await ensureCenterFromGeolocation();
            map.flyTo(nearbyCenter, Math.max(map.getZoom(), 12), { duration: 0.6 });
          } catch(err){ alert('ლოკაციის მიღება ვერ მოხერხდა: ' + (err.message||err)); }
        });
        this._apply.addEventListener('click', async ()=>{
          try {
            await ensureCenterFromGeolocation();
            const km = Math.max(1, Math.min(100, parseInt(this._num.value || '5', 10)));
            applyNearby(nearbyCenter, km);
          } catch(err){ alert('გთხოვ, მიეცი წვდომა მდებარეობაზე.'); }
        });
        this._clear.addEventListener('click', ()=> { clearNearby(); });

        return div;
      }
    });
    const nearbyCtl = new NearbyControl();
    map.addControl(nearbyCtl);

    // ----------------------- SEARCH -----------------------
    let pointsMarkerByKey = {};
    let fuse = null;
    let rawIndex = [];

    function buildPointsIndex(layer) {
      pointsMarkerByKey = {};
      const items = [];
      layer.eachLayer(m => {
        if (!m.getLatLng) return;
        const ll = m.getLatLng();
        const p  = (m.feature && m.feature.properties) || {};
        const label = p.title || p.name || p.Name || 'უსათაურო';
        const sub   = p.address || p.description || p.desc || '';
        const key   = JSON.stringify([label, +ll.lng.toFixed(6), +ll.lat.toFixed(6), 'POINT']);
        pointsMarkerByKey[key] = m;
        items.push({ key, label, sublabel: sub, latlng: ll, source: 'points' });
      });
      return items;
    }

    function rebuildFuse(){
      fuse = new Fuse(rawIndex, {
        keys: ['label','sublabel','brandLabel'],
        threshold: 0.35,
        ignoreLocation: true,
        includeScore: true
      });
      searchCtl.setSearch(q => q ? fuse.search(q) : []);
      searchCtl.bindInput();
    }

    function goToPointByKey(key, ll){
      if (mainLayer && !map.hasLayer(mainLayer)) map.addLayer(mainLayer);
      map.flyTo(ll, 16, { duration: 0.8 });
      const lyr = pointsMarkerByKey[key];
      if (lyr) setTimeout(() => lyr.openPopup(), 850);
    }

    function goToLpgByKey(key, ll, brandLabel){
      if (!map.hasLayer(lpgMaster)) map.addLayer(lpgMaster);
      lpgFilter.setChecked([brandLabel]);
      applyLpgSelection();
      if (nearbyActive) {
        // Nearby ფილტრის დროს უბრალოდ გადავფრინდეთ კოორდინატზე
        map.flyTo(ll, 16, { duration: 0.6 });
        return;
      }
      const rec = lpgMarkersByKey[key];
      const cluster = lpgClustersByBrand[brandLabel];
      if (rec && cluster) {
        cluster.zoomToShowLayer(rec.marker, () => {
          map.flyTo(ll, 16, { duration: 0.6 });
          rec.marker.openPopup();
        });
      } else {
        map.flyTo(ll, 16, { duration: 0.8 });
      }
    }

    // ----------------------- LOAD DATA -----------------------
    let lpgMarkersReadyForSearch = false;

    function addToSearchFromPoints(){ rawIndex = rawIndex.concat(buildPointsIndex(mainLayer)); }
    function addToSearchFromLpg(){
      Object.entries(lpgMarkersByKey).forEach(([k, v]) => {
        const m = v.marker;
        const ll = m.getLatLng();
        const p = (m.feature && m.feature.properties) || {};
        const label = p.title || p.name || p.Name || 'უსათაურო';
        const sub   = p.address || p.description || p.desc || '';
        rawIndex.push({ key: k, label, sublabel: sub, latlng: ll, source: 'lpg', brandLabel: v.brand });
      });
      lpgMarkersReadyForSearch = true;
    }

    function readySearch(){
      rebuildFuse();
      searchCtl.setSelect((item) => {
        if (item.source === 'points') { goToPointByKey(item.key, item.latlng); }
        else { goToLpgByKey(item.key, item.latlng, item.brandLabel); }
      });
    }

    (async function init(){
      // points overlay (სტარტზე რუკაზე არაა)
      try {
        const res = await fetch(mainUrl, { cache: 'no-cache' });
        if (!res.ok) throw new Error('no external geojson');
        const gj = await res.json();
        mainLayer = makeGeoJsonLayer(gj);
        layerControl.addOverlay(mainLayer, 'ობიექტები (points.geojson)');
        addToSearchFromPoints();
      } catch(e){
        console.warn('points.geojson ვერ ჩაიტვირთა:', e);
      }

      // LPG
      try {
        const res = await fetch(lpgUrl, { cache: 'no-cache' });
        if (!res.ok) throw new Error('no LPG layer');
        const lpgGJ = await res.json();

        const ret = buildLpgBrandData(lpgGJ);
        lpgClustersByBrand = ret.clustersByBrand;
        lpgCountsByBrand   = ret.countsByBrand;
        lpgBrandList       = ret.brandList;
        lpgMarkersByKey    = ret.markersByKey;
        lpgReady = true;

        lpgFilter.setBrands(lpgBrandList, lpgCountsByBrand, applyLpgSelection);
        addToSearchFromLpg();
      } catch (e) {
        console.warn('LPG.geojson ვერ ჩაიტვირთა:', e);
        lpgFilter.hide();
        lpgFilterToggle.hide();
      }

      readySearch();
    })();
  </script>
</body>
</html>
